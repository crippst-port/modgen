/*! aiplacement_modgen - v1.0.0 - 2025-10-20
 * @license GPL-3.0-or-later or later
 */
define(["core/templates"],function(a){var e=null;function n(t){var e;return t?(e="",t.heading&&(e+=t.heading+"\n\n"),t.paragraphs&&Array.isArray(t.paragraphs)&&(e+=t.paragraphs.join("\n\n")),e):""}function r(t){return document.getElementById(t)||null}function i(t,e){t=r(t);t&&(t.style.display=e)}return{init:function(t,e,n){this.enableRefreshButton(t),this.loadInsights(t)},loadInsights:function(e,t){var n=this,a=M.cfg.wwwroot+"/ai/placement/modgen/ajax/explore_ajax.php?courseid="+e;t&&(a+="&refresh=1"),fetch(a).then(function(t){if(t.ok)return t.json();throw new Error("HTTP error "+t.status)}).then(function(t){!t.error&&t.success&&t.data?(n.processInsights(t.data),n.renderAllSections(t.data),n.hideLoadingAndShowContent(),n.renderChartsIfAvailable(t.data),n.enableDownloadButton(e)):n.hideLoadingAndShowContent()}).catch(function(t){n.hideLoadingAndShowContent()})},processInsights:function(t){e={pedagogical:n(t.pedagogical),learningTypes:n(t.learning_types),improvements:this.extractImprovementsText(t.improvements),chartData:t.chart_data}},extractImprovementsText:function(t){var e;return t?(e="",t.summary&&(e+=t.summary+"\n\n"),t.suggestions&&Array.isArray(t.suggestions)&&(e+=t.suggestions.join("\n")),e):""},renderAllSections:function(t){t.pedagogical&&this.renderPedagogicalSection(t.pedagogical),t.summary&&this.renderTemplateSection("aiplacement_modgen/insights_summary",t.summary,"insights-summary"),t.workload_analysis&&this.renderTemplateSection("aiplacement_modgen/workload_analysis",t.workload_analysis,"insights-workload-analysis"),t.improvements&&this.renderTemplateSection("aiplacement_modgen/improvements",t.improvements,"insights-improvements")},renderPedagogicalSection:function(t){var e,n,a=r("insights-pedagogical");a&&((e=r("ped-heading"))&&(e.textContent=t.heading||""),(n=r("ped-content"))&&t.paragraphs&&Array.isArray(t.paragraphs)&&(n.innerHTML="",t.paragraphs.forEach(function(t){var e=document.createElement("p");e.textContent=t,n.appendChild(e)})),a.style.display="block")},renderTemplateSection:function(t,e,n){a.renderForPromise(t,e).then(function(t){var e=r(n);e&&(e.innerHTML=t.html)}).catch(function(){})},renderChartsIfAvailable:function(t){var e=this;t.chart_data&&t.chart_data.hasActivities&&setTimeout(function(){e.renderLearningTypesChart(t.chart_data)},100),t.section_chart_data&&t.section_chart_data.hasActivities&&setTimeout(function(){e.renderSectionActivityChart(t.section_chart_data)},500)},hideLoadingAndShowContent:function(){i("insights-loading","none"),i("content-wrapper","block"),this.initializeTabs()},initializeTabs:function(){var e=document.querySelectorAll('#myTab button[data-bs-toggle="tab"]');e.forEach(function(t){t.addEventListener("click",function(t){t.preventDefault();var t=this.getAttribute("data-bs-target");t&&(e.forEach(function(t){t.classList.remove("active"),t.setAttribute("aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(function(t){t.classList.remove("active","show")}),this.classList.add("active"),this.setAttribute("aria-selected","true"),t=document.querySelector(t))&&t.classList.add("active","show")})})},renderLearningTypesChart:function(n){require(["jquery","core/chartjs"],function(){setTimeout(function(){var t=r("learning-types-chart");if(t){t=t.getContext("2d");if(t){var e={type:"pie",data:{labels:n.labels,datasets:[{data:n.data,backgroundColor:n.colors,borderColor:"#fff",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:function(t){var e=t.label||"";return e&&(e+=": "),e+=t.parsed}}}}}};try{new Chart(t,e)}catch(t){}}}},100)})},renderSectionActivityChart:function(n){require(["jquery","core/chartjs"],function(){setTimeout(function(){var t=r("section-activity-chart");if(t){t=t.getContext("2d");if(t){var e={type:"bar",data:{labels:n.labels,datasets:[{label:"Activities",data:n.data,backgroundColor:n.backgroundColor,borderColor:n.borderColor,borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(t){return"Activities: "+t.parsed.x}}}},scales:{x:{beginAtZero:!0,ticks:{stepSize:1}}}}};try{new Chart(t,e)}catch(t){}}}},100)})},enableDownloadButton:function(t){var e=this,n=r("download-report-btn");n&&(n.disabled=!1,n.title="Download the module exploration report as PDF",n.addEventListener("click",function(){e.downloadReport(t)}))},downloadReport:function(t){e?(t=M.cfg.wwwroot+"/ai/placement/modgen/ajax/download_report_pdf.php?courseid="+t,fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(function(t){if(t.ok)return t.blob();throw new Error("HTTP error "+t.status)}).then(function(t){var t=window.URL.createObjectURL(t),e=document.createElement("a");e.href=t,e.download="module_exploration_report.pdf",document.body.appendChild(e),e.click(),window.URL.revokeObjectURL(t),document.body.removeChild(e)}).catch(function(t){alert("Error downloading PDF: "+t.message)})):alert("Report data is not available. Please wait for the insights to load.")},refreshInsights:function(t){i("insights-loading","block"),i("content-wrapper","none"),this.loadInsights(t,!0)},enableRefreshButton:function(t){var e=this,n=r("refresh-insights-btn");n&&n.addEventListener("click",function(){e.refreshInsights(t)})}}});