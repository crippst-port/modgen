/*! aiplacement_modgen - v1.0.0 - 2025-10-20
 * @license GPL-3.0-or-later or later
 */
define(["core/templates"],function(a){var t=null;function n(e){var t;return e?(t="",e.heading&&(t+=e.heading+"\n\n"),e.paragraphs&&Array.isArray(e.paragraphs)&&(t+=e.paragraphs.join("\n\n")),t):""}function r(e){return document.getElementById(e)||null}function o(e,t){e=r(e);e&&(e.style.display=t)}return{init:function(e,t,n){this.enableRefreshButton(e),this.loadInsights(e)},loadInsights:function(t,e){var n=this,a=M.cfg.wwwroot+"/ai/placement/modgen/ajax/explore_ajax.php?courseid="+t;e&&(a+="&refresh=1"),fetch(a).then(function(e){if(e.ok)return e.json();throw new Error("HTTP error "+e.status)}).then(function(e){!e.error&&e.success&&e.data?(n.processInsights(e.data),n.renderAllSections(e.data),n.hideLoadingAndShowContent(),n.renderChartsIfAvailable(e.data),n.enableDownloadButton(t)):n.hideLoadingAndShowContent()}).catch(function(e){n.hideLoadingAndShowContent()})},processInsights:function(e){t={pedagogical:n(e.pedagogical),learningTypes:n(e.learning_types),improvements:this.extractImprovementsText(e.improvements),chartData:e.chart_data}},extractImprovementsText:function(e){var t;return e?(t="",e.summary&&(t+=e.summary+"\n\n"),e.suggestions&&Array.isArray(e.suggestions)&&(t+=e.suggestions.join("\n")),t):""},renderAllSections:function(e){e.pedagogical&&this.renderPedagogicalSection(e.pedagogical),e.summary&&this.renderTemplateSection("aiplacement_modgen/insights_summary",e.summary,"insights-summary"),e.workload_analysis&&this.renderTemplateSection("aiplacement_modgen/workload_analysis",e.workload_analysis,"insights-workload-analysis"),e.improvements&&this.renderTemplateSection("aiplacement_modgen/improvements",e.improvements,"insights-improvements")},renderPedagogicalSection:function(e){var t,n,a=r("insights-pedagogical");a&&((t=r("ped-heading"))&&(t.textContent=e.heading||""),(n=r("ped-content"))&&e.paragraphs&&Array.isArray(e.paragraphs)&&(n.innerHTML="",e.paragraphs.forEach(function(e){var t=document.createElement("p");t.textContent=e,n.appendChild(t)})),a.style.display="block")},renderTemplateSection:function(e,t,n){a.renderForPromise(e,t).then(function(e){var t=r(n);t&&(t.innerHTML=e.html)}).catch(function(){})},renderChartsIfAvailable:function(e){var t=this;e.chart_data&&e.chart_data.hasActivities&&setTimeout(function(){t.renderLearningTypesChart(e.chart_data)},100),e.section_chart_data&&e.section_chart_data.hasActivities&&setTimeout(function(){t.renderSectionActivityChart(e.section_chart_data)},500)},hideLoadingAndShowContent:function(){o("insights-loading","none"),o("content-wrapper","block")},renderLearningTypesChart:function(n){require(["jquery","core/chartjs"],function(){setTimeout(function(){var e=r("learning-types-chart");if(e){e=e.getContext("2d");if(e){var t={type:"pie",data:{labels:n.labels,datasets:[{data:n.data,backgroundColor:n.colors,borderColor:"#fff",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:function(e){var t=e.label||"";return t&&(t+=": "),t+=e.parsed}}}}}};try{new Chart(e,t)}catch(e){}}}},100)})},renderSectionActivityChart:function(n){require(["jquery","core/chartjs"],function(){setTimeout(function(){var e=r("section-activity-chart");if(e){e=e.getContext("2d");if(e){var t={type:"bar",data:{labels:n.labels,datasets:[{label:"Activities",data:n.data,backgroundColor:n.backgroundColor,borderColor:n.borderColor,borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"Activities: "+e.parsed.x}}}},scales:{x:{beginAtZero:!0,ticks:{stepSize:1}}}}};try{new Chart(e,t)}catch(e){}}}},100)})},enableDownloadButton:function(e){var t=this,n=r("download-report-btn");n&&(n.disabled=!1,n.title="Download the module exploration report as PDF",n.addEventListener("click",function(){t.downloadReport(e)}))},downloadReport:function(e){t?(e=M.cfg.wwwroot+"/ai/placement/modgen/ajax/download_report_pdf.php?courseid="+e,fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(function(e){if(e.ok)return e.blob();throw new Error("HTTP error "+e.status)}).then(function(e){var e=window.URL.createObjectURL(e),t=document.createElement("a");t.href=e,t.download="module_exploration_report.pdf",document.body.appendChild(t),t.click(),window.URL.revokeObjectURL(e),document.body.removeChild(t)}).catch(function(e){alert("Error downloading PDF: "+e.message)})):alert("Report data is not available. Please wait for the insights to load.")},refreshInsights:function(e){o("insights-loading","block"),o("content-wrapper","none"),this.loadInsights(e,!0)},enableRefreshButton:function(e){var t=this,n=r("refresh-insights-btn");n&&n.addEventListener("click",function(){t.refreshInsights(e)})}}});