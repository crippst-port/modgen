define(["core/modal_events","aiplacement_modgen/modal"],function(ModalEvents,ModgenModal){var createButton=function(params){var button=document.createElement("button");button.type="button";button.classList.add("btn","btn-primary","aiplacement-modgen__fab");button.setAttribute("aria-label",params.arialabel);button.setAttribute("aria-haspopup","dialog");button.setAttribute("aria-expanded","false");button.textContent=params.buttonlabel;document.body.appendChild(button);return button};var modalPromise=null;var modalInstance=null;var shouldRefresh=false;var reloadTriggered=false;var footerButtonBindings=[];var getModalUrl=function(baseUrl,params){var url=new URL(baseUrl,window.location.origin);url.searchParams.set("ajax","1");if(params.embedded){url.searchParams.set("embedded","1")}if(typeof M!=="undefined"&&M.cfg&&M.cfg.sesskey&&!url.searchParams.has("sesskey")){url.searchParams.set("sesskey",M.cfg.sesskey)}return url};var executeInlineScripts=function(){if(!modalInstance){return}var body=modalInstance.getBody();var bodyNode=body&&body.length?body.get(0):null;if(!bodyNode){return}var scripts=bodyNode.querySelectorAll("script");Array.prototype.forEach.call(scripts,function(script){var replacement=document.createElement("script");if(script.type){replacement.type=script.type}if(script.src){replacement.src=script.src;replacement.async=false}else{replacement.text=script.textContent}script.parentNode.replaceChild(replacement,script)});if(typeof M!=="undefined"&&M.form&&typeof M.form.updateFormState==="function"){var forms=bodyNode.querySelectorAll("form.mform");Array.prototype.forEach.call(forms,function(form){try{M.form.updateFormState(form.getAttribute("id"))}catch(error){console.warn("Failed to refresh form state",error)}})}};var collectSubmitButtons=function(form){var bindings=[];var submitters=form.querySelectorAll('button[type="submit"], input[type="submit"]');Array.prototype.forEach.call(submitters,function(submitter){var originalClasses=(submitter.className||"").split(/\s+/).filter(Boolean);var classes=[];originalClasses.forEach(function(cls){if(classes.indexOf(cls)===-1){classes.push(cls)}});if(classes.indexOf("btn")===-1){classes.push("btn")}var hasVariant=classes.some(function(cls){return cls.indexOf("btn-")===0});if(!hasVariant){classes.push("btn-secondary")}if(submitter.classList&&submitter.classList.contains("btn-primary")&&classes.indexOf("btn-primary")===-1){classes.push("btn-primary");var secondaryIndex=classes.indexOf("btn-secondary");if(secondaryIndex!==-1){classes.splice(secondaryIndex,1)}}var labelSource=submitter.tagName==="INPUT"?(submitter.value||submitter.getAttribute("value")||submitter.getAttribute("aria-label")||submitter.name||""):submitter.textContent;var label=(labelSource||"").trim()||"Submit";bindings.push({label:label,classes:classes.join(" "),form:form,submitter:submitter});var container=submitter.closest(".form-submit, .form-actions, .form-buttons, .buttons");if(container){container.classList.add("aiplacement-modgen__hidden-submit");container.setAttribute("aria-hidden","true");container.hidden=true}else{submitter.classList.add("aiplacement-modgen__hidden-submit");submitter.setAttribute("aria-hidden","true");submitter.hidden=true}});return bindings};var updateFooterButtons=function(buttonBindings){footerButtonBindings=buttonBindings||[];if(!modalInstance){return}var footer=modalInstance.getFooter();var footerNode=footer&&footer.length?footer.get(0):null;if(!footerNode){return}var submitButtons=footerNode.querySelectorAll('[data-action="aiplacement-modgen-submit"]');Array.prototype.forEach.call(submitButtons,function(button,index){if(!button.hasAttribute("data-button-index")){button.dataset.buttonIndex=String(index)}})};var bindCloseButtons=function(){if(!modalInstance){return}var nodes=[];var body=modalInstance.getBody();var footer=modalInstance.getFooter();if(body&&body.length){nodes.push(body.get(0))}if(footer&&footer.length){nodes.push(footer.get(0))}if(!nodes.length){return}nodes.forEach(function(node){var buttons=node.querySelectorAll('[data-action="aiplacement-modgen-close"]');Array.prototype.forEach.call(buttons,function(button){if(button.dataset.modgenCloseBound==="1"){return}button.dataset.modgenCloseBound="1";button.addEventListener("click",function(event){event.preventDefault();shouldRefresh=true;modalInstance.hide()})})})};var setupKeepWeekLabelsToggle=function(form){if(form.dataset.modgenWeekToggle==="1"){return}var moduleselect=form.querySelector('select[name="moduletype"]');var keepweekitem=form.querySelector("#fitem_id_keepweeklabels");if(!moduleselect||!keepweekitem){return}var checkbox=keepweekitem.querySelector('input[name="keepweeklabels"]');var updateVisibility=function(){var isWeekly=moduleselect.value==="weekly";keepweekitem.style.display=isWeekly?"":"none";keepweekitem.setAttribute("aria-hidden",isWeekly?"false":"true");if(!isWeekly&&checkbox){checkbox.checked=false}};moduleselect.addEventListener("change",updateVisibility);updateVisibility();form.dataset.modgenWeekToggle="1"};var enhanceForms=function(params){if(!modalInstance){return[]}var body=modalInstance.getBody();var bodyNode=body&&body.length?body.get(0):null;if(!bodyNode){return[]}var bindings=[];var forms=bodyNode.querySelectorAll("form");Array.prototype.forEach.call(forms,function(form){if(form.dataset.modgenEnhanced!=="1"){form.dataset.modgenEnhanced="1";form.addEventListener("submit",function(event){event.preventDefault();var formData=new FormData(form);formData.append("ajax","1");if(params.embedded){formData.append("embedded","1")}if(!formData.has("sesskey")&&typeof M!=="undefined"&&M.cfg&&M.cfg.sesskey){formData.append("sesskey",M.cfg.sesskey)}loadContent(params,formData)});setupKeepWeekLabelsToggle(form)}bindings=bindings.concat(collectSubmitButtons(form))});return bindings};var showError=function(message){if(!modalInstance){return}var safeMessage=message||"Unable to load content.";modalInstance.setBody('<div class="alert alert-danger" role="alert">'+safeMessage+"</div>");modalInstance.setFooter("")};var setLoadingState=function(){if(!modalInstance){return}modalInstance.setBody('<div class="aiplacement-modgen__loading"><span class="spinner-border" role="status" aria-hidden="true"></span></div>');modalInstance.setFooter("")};var processPayload=function(payload,params){if(!modalInstance){return}if(!payload||typeof payload!=="object"){showError("Unexpected response from server.");return}if(payload.error){showError(payload.error);return}if(payload.title){modalInstance.setTitle(payload.title)}var bodyHtml=payload.body||"";var footerHtml=payload.footer||"";modalInstance.setBody(bodyHtml);modalInstance.setFooter(footerHtml);shouldRefresh=shouldRefresh||Boolean(payload.refresh);executeInlineScripts();var buttonBindings=enhanceForms(params);updateFooterButtons(buttonBindings);bindCloseButtons();if(payload.close){modalInstance.hide()}};var loadContent=function(params,formData){if(!modalInstance){return Promise.resolve()}setLoadingState();var url=getModalUrl(params.url,params);var options={method:formData?"POST":"GET",credentials:"same-origin",headers:{Accept:"application/json"}};if(formData){options.body=formData}return fetch(url.toString(),options).then(function(response){if(!response.ok){throw new Error("Failed to load modal content.")}return response.json()}).then(function(payload){processPayload(payload,params)}).catch(function(error){console.error(error);showError(error.message)})};var getModal=function(params,trigger){if(!modalPromise){modalPromise=ModgenModal.create({title:params.dialogtitle,body:""}).then(function(modal){modalInstance=modal;modal.getRoot().on("click",'[data-action="aiplacement-modgen-submit"]',function(event){event.preventDefault();var button=event.currentTarget;if(!button){return}var indexValue=button.getAttribute("data-button-index");var index=indexValue?parseInt(indexValue,10):NaN;if(isNaN(index)){return}var binding=footerButtonBindings[index];if(!binding||!binding.submitter||!binding.form){return}var form=binding.form;var submitter=binding.submitter;if(typeof form.requestSubmit==="function"){form.requestSubmit(submitter)}else{submitter.click()}});modal.getRoot().on("click",'[data-action="aiplacement-modgen-reenter"]',function(event){event.preventDefault();footerButtonBindings=[];loadContent(params)});modal.getRoot().on(ModalEvents.shown,function(){trigger.setAttribute("aria-expanded","true");if(!modalInstance.getBody().html()){loadContent(params)}});modal.getRoot().on(ModalEvents.hidden,function(){trigger.setAttribute("aria-expanded","false");footerButtonBindings=[];if(shouldRefresh&&!reloadTriggered){reloadTriggered=true;window.location.reload()}});modal.getRoot().on(ModalEvents.destroyed,function(){modalPromise=null;modalInstance=null;shouldRefresh=false;reloadTriggered=false;footerButtonBindings=[];trigger.setAttribute("aria-expanded","false")});return modal}).catch(function(error){modalPromise=null;modalInstance=null;shouldRefresh=false;reloadTriggered=false;footerButtonBindings=[];throw error})}return modalPromise};var init=function(params){if(!params||!params.url){return}params.embedded=params.embedded||params.url.indexOf("embedded=1")!==-1;if(document.querySelector(".aiplacement-modgen__fab")){return}var trigger=createButton(params);trigger.addEventListener("click",function(event){event.preventDefault();getModal(params,trigger).then(function(modal){modal.show();if(!modal.getBody().html()){loadContent(params)}}).catch(function(error){console.error("Failed to initialise Module Generator modal",error);trigger.remove()})})};return{init:init}});