/*! aiplacement_modgen - v1.0.0 - 2025-11-18
 * @license GPL-3.0-or-later or later
 */
define([],function(){define(["core/modal_events","aiplacement_modgen/modal","core/str","core/templates"],function(o,i,l,n){let e="Thinking...",s=null,d=null,c=!1,m=!1,u=[],g=!0,p=e=>{e=new URL(e,window.location.origin);return e.searchParams.set("ajax","1"),"undefined"!=typeof M&&M.cfg&&M.cfg.sesskey&&!e.searchParams.has("sesskey")&&e.searchParams.set("sesskey",M.cfg.sesskey),e},r=()=>{var e;d&&(e=(e=d.getBody())&&e.length?e.get(0):null)&&(e.querySelectorAll("script").forEach(e=>{var t=document.createElement("script");e.type&&(t.type=e.type),e.src?(t.src=e.src,t.async=!1):t.textContent=e.textContent,e.replaceWith(t)}),"undefined"!=typeof M)&&M.form&&"function"==typeof M.form.updateFormState&&e.querySelectorAll("form.mform").forEach(e=>{try{M.form.updateFormState(e.getAttribute("id"))}catch(e){console.warn("Failed to refresh form state",e)}})},f=a=>{let r=[];return a.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(e=>{var t=(e.className||"").split(/\s+/).filter(Boolean),t=new Set(t),n=(t.add("btn"),Array.from(t).some(e=>0===e.indexOf("btn-")));n||t.add("btn-secondary"),e.classList.contains("btn-primary")&&(t.delete("btn-secondary"),t.add("btn-primary"));n=(("INPUT"===e.tagName?e.value||e.getAttribute("value")||e.getAttribute("aria-label")||e.name||"":e.textContent)||"").trim()||"Submit",r.push({label:n,classes:Array.from(t).join(" "),form:a,submitter:e}),n=e.closest(".form-submit, .form-actions, .form-buttons, .buttons");n?(n.classList.add("aiplacement-modgen__hidden-submit"),n.setAttribute("aria-hidden","true"),n.hidden=!0):(e.classList.add("aiplacement-modgen__hidden-submit"),e.setAttribute("aria-hidden","true"),e.hidden=!0)}),r},h=e=>{u=e||[],d&&(e=(e=d.getFooter())&&e.length?e.get(0):null)&&e.querySelectorAll('[data-action="aiplacement-modgen-submit"]').forEach((e,t)=>{e.hasAttribute("data-button-index")||(e.dataset.buttonIndex=String(t))})},b=()=>{var e,t,n;d&&(e=[],t=d.getBody(),n=d.getFooter(),t&&t.length&&e.push(t.get(0)),n&&n.length&&e.push(n.get(0)),e.length)&&e.forEach(e=>{e.querySelectorAll('[data-action="aiplacement-modgen-close"]').forEach(e=>{"1"!==e.dataset.modgenCloseBound&&(e.dataset.modgenCloseBound="1",e.addEventListener("click",e=>{e.preventDefault(),c=!0,d.hide()}))})})},y=r=>{if(!d)return[];var e=d.getBody(),e=e&&e.length?e.get(0):null;if(!e)return[];let t=[];return e.querySelectorAll("form").forEach(a=>{"1"!==a.dataset.modgenEnhanced&&(a.dataset.modgenEnhanced="1",a.addEventListener("submit",e=>{e.preventDefault();e=new FormData(a);e.append("ajax","1"),r.embedded&&e.append("embedded","1"),!e.has("sesskey")&&"undefined"!=typeof M&&M.cfg&&M.cfg.sesskey&&e.append("sesskey",M.cfg.sesskey);try{var t,n=[];for(t of e.entries())t[1]instanceof File?n.push({key:t[0],filename:t[1].name,size:t[1].size}):n.push({key:t[0],value:"string"==typeof t[1]?t[1].slice(0,200):String(t[1])});console.debug("Module Generator form submit FormData entries:",n)}catch(e){console.warn("Failed to inspect FormData for debugging",e)}k(r,e)})),t.push(...f(a))}),t},v=e=>{d&&(e=e||"Unable to load content.",d.setBody('<div class="alert alert-danger" role="alert">'+e+"</div>"),d.setFooter(""))},_=()=>{if(d){let t=e=>{var t=d.getBody(),t=t&&t.length?t.get(0):null;t&&(t=t.querySelector(".aiplacement-modgen__loading-message"))&&(t.textContent=e)};d.setBody('<div class="aiplacement-modgen__loading" role="status" aria-live="polite"><span class="spinner-border" aria-hidden="true"></span><p class="aiplacement-modgen__loading-message"></p></div>'),d.setFooter(""),t(e),l&&"function"==typeof l.get_string&&l.get_string("processing","aiplacement_modgen").then(e=>{t(e)}).catch(()=>{l.get_string("loadingthinking","aiplacement_modgen").then(e=>{t(e)}).catch(()=>{t(e)})})}},A=(e,t)=>{var n,a;d&&(e&&"object"==typeof e?e.error?v(e.error):(e.title&&d.setTitle(e.title),a=e.body||"",n=e.footer||"",d.setBody(a),d.setFooter(n),c=c||Boolean(e.refresh),r(),a=y(t),h(a),b(),g=!1,e.close&&d.hide()):v("Unexpected response from server."))},k=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(!d)return Promise.resolve();_();var n=p(t.url);let a=new AbortController,r=setTimeout(()=>a.abort(),3e5);var o={method:e?"POST":"GET",credentials:"same-origin",headers:{Accept:"application/json"},signal:a.signal};if(e&&(o.body=e,d)){e=d.getBody(),e=e&&e.length?e.get(0):null;if(e){let t=e.querySelector(".aiplacement-modgen__loading-message");t&&l.get_string("aiprocessingdetail","aiplacement_modgen").then(e=>{t&&(t.textContent=e)}).catch(()=>{t&&(t.textContent="AI is analyzing your request and generating module content. This process may take several minutes for complex requests.")})}}return fetch(n.toString(),o).then(e=>{if(clearTimeout(r),e.ok)return e.json();throw new Error("Failed to load modal content.")}).then(e=>{A(e,t)}).catch(e=>{clearTimeout(r),console.error(e),"AbortError"===e.name?v("Your request is taking longer than expected. Please try with a shorter prompt or try again later."):v(e.message)})};return{init:async r=>{var e,t;if(r&&r.url&&(r.embedded=r.embedded||-1!==r.url.indexOf("embedded=1"),!document.querySelector(".aiplacement-modgen__fab")))try{e={arialabel:(e=r).arialabel,buttonlabel:e.buttonlabel},e=(await n.renderForPromise("aiplacement_modgen/fab_button",e)).html,(t=document.createElement("div")).innerHTML=e,e=t.firstElementChild,document.body.appendChild(e);let a=await e;a.addEventListener("click",e=>{var t,n;e.preventDefault(),t=r,n=a,(s=s||i.create({title:t.dialogtitle,body:""}).then(e=>((d=e).getRoot().on("click",'[data-action="aiplacement-modgen-submit"]',e=>{e.preventDefault();var t,e=e.currentTarget;e&&(e=(e=e.getAttribute("data-button-index"))?parseInt(e,10):NaN,Number.isNaN(e)||(e=u[e])&&e.submitter&&e.form&&(t=e.form,e=e.submitter,"function"==typeof t.requestSubmit?t.requestSubmit(e):e.click()))}),e.getRoot().on("click",'[data-action="aiplacement-modgen-reenter"]',e=>{e.preventDefault(),u=[],k(t)}),e.getRoot().on(o.shown,()=>{n.setAttribute("aria-expanded","true"),!g&&d.getBody().html()||k(t)}),e.getRoot().on(o.hidden,()=>{n.setAttribute("aria-expanded","false"),u=[],g=!0,c&&!m&&(m=!0,window.location.reload())}),e.getRoot().on(o.destroyed,()=>{s=null,d=null,c=!1,m=!1,u=[],g=!0}),document.addEventListener("aiplacement-modgen-forms-updated",()=>{var e;d&&(e=y(t),h(e))}),e)).catch(e=>{throw s=null,d=null,c=!1,m=!1,u=[],e})).then(e=>{e.show(),e.getBody().html()||k(r)}).catch(e=>{console.error("Failed to initialise Module Generator modal",e),a.remove()})})}catch(e){console.error("Failed to create Module Generator FAB",e)}}}})});