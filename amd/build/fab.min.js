define(["core/modal","core/modal_events"],(function(Modal,ModalEvents){const createButton=params=>{const button=document.createElement("button");return button.type="button",button.classList.add("btn","btn-primary","aiplacement-modgen__fab"),button.setAttribute("aria-label",params.arialabel),button.setAttribute("aria-haspopup","dialog"),button.setAttribute("aria-expanded","false"),button.textContent=params.buttonlabel,document.body.appendChild(button),button};let modalPromise=null,modalInstance=null,messageListenerRegistered=!1,shouldRefresh=!1,reloadTriggered=!1;const MESSAGE_TYPES={READY:"aiplacement_modgen_ready",CLOSE:"aiplacement_modgen_close",REFRESH:"aiplacement_modgen_refresh"},handleMessage=event=>{if(!event||event.origin!==window.location.origin||!event.data)return;if(event.data.type===MESSAGE_TYPES.READY){shouldRefresh=!0;return}if(event.data.type===MESSAGE_TYPES.REFRESH){shouldRefresh=!0,modalInstance&&modalInstance.hide();return}event.data.type===MESSAGE_TYPES.CLOSE&&modalInstance&&(shouldRefresh?(modalInstance.hide(),void 0):modalInstance.hide())},getModal=(params,trigger)=>{if(!modalPromise){modalPromise=Modal.create({title:params.dialogtitle,body:"",large:!0},trigger).then((modal=>{modalInstance=modal;const body=modal.getBody();body.empty();const iframe=document.createElement("iframe");return iframe.className="aiplacement-modgen__iframe",iframe.setAttribute("title",params.dialogtitle),iframe.setAttribute("allow","clipboard-write"),iframe.setAttribute("loading","lazy"),body.append(iframe),modal.getRoot().on(ModalEvents.shown,(()=>{trigger.setAttribute("aria-expanded","true"),iframe.src||(iframe.src=params.url);})),modal.getRoot().on(ModalEvents.hidden,(()=>{trigger.setAttribute("aria-expanded","false"),shouldRefresh&&!reloadTriggered&&(reloadTriggered=!0,window.location.reload());})),modal.getRoot().on(ModalEvents.destroyed,(()=>{modalPromise=null,modalInstance=null,shouldRefresh=!1,reloadTriggered=!1,trigger.setAttribute("aria-expanded","false");})),modal})).catch((error=>{modalPromise=null,modalInstance=null,shouldRefresh=!1,reloadTriggered=!1;throw error;}));}return modalPromise};const init=params=>{if(!params||!params.url||document.querySelector(".aiplacement-modgen__fab"))return;const trigger=createButton(params);messageListenerRegistered||(window.addEventListener("message",handleMessage),messageListenerRegistered=!0);trigger.addEventListener("click",(event=>{event.preventDefault(),getModal(params,trigger).then((modal=>{modal.show();})).catch((error=>{console.error("Failed to initialise Module Generator modal",error),trigger.remove();}));}));};return{init:init}}));