/*! aiplacement_modgen - v1.0.0 - 2025-11-19
 * @license GPL-3.0-or-later or later
 */
define(["exports","core/reactive","core/event_dispatcher","core/fragment","aiplacement_modgen/modal","core/notification","core/modal_events"],function(e,t,a,s,o,d,i){function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0}),e.init=void 0,s=n(s),o=n(o),d=n(d),i=n(i);let l={stateChanged:"aiplacement_modgen/statechanged"};let r=new t.Reactive({name:"ModalGenerator",eventName:l.stateChanged,eventDispatch:(e,t)=>(0,a.dispatchEvent)(l.stateChanged,e,t),state:{modal:{isOpen:!1,isLoading:!1,formName:null,title:""},form:{isValid:!1,isDirty:!1,isSubmitting:!1}},mutations:new class{openModalWithForm(e,t,a){e.setReadOnly(!1),e.state.modal.isOpen=!0,e.state.modal.isLoading=!0,e.state.modal.formName=t,e.state.modal.title=a,e.setReadOnly(!0)}openModal(e){e.setReadOnly(!1),e.state.modal.isOpen=!0,e.state.modal.isLoading=!0,e.state.modal.formName=null,e.state.modal.title="Module Generator",e.setReadOnly(!0)}closeModal(e){e.setReadOnly(!1),e.state.modal.isOpen=!1,e.state.modal.isLoading=!1,e.state.modal.formName=null,e.state.modal.title="",e.setReadOnly(!0)}formLoaded(e){e.setReadOnly(!1),e.state.modal.isLoading=!1,e.setReadOnly(!0)}}});class c extends t.BaseComponent{create(e){this.courseid=e.courseid,this.contextid=e.contextid,this.modal=null}stateReady(){}getWatchers(){return[{watch:"modal.isOpen:updated",handler:this.handleModalStateChange},{watch:"modal.isLoading:updated",handler:this.handleLoadingChange}]}handleModalStateChange(e){e=e.state;e.modal.isOpen&&!this.modal?this.createModal():!e.modal.isOpen&&this.modal?(this.modal.destroy(),this.modal=null):e.modal.isOpen&&this.modal&&this.modal.show()}handleLoadingChange(e){e=e.state;this.modal&&e.modal.isLoading&&this.modal.setBody('<div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>')}createModal(){var e=this.reactive.state.modal.formName,t=this.reactive.state.modal.title||"Module Generator";e?this.loadFormInModal(e,t):this.showGeneratorLink(t)}loadFormInModal(t,a){s.default.loadFragment("aiplacement_modgen","form_".concat(t),this.contextid,{courseid:this.courseid}).then(e=>o.default.create({title:a,body:e,large:!1})).then(e=>(this.modal=e,this.modal.getRoot().on(i.default.hidden,()=>{this.reactive.dispatch("closeModal")}),this.setupFormSubmission(e,t),this.reactive.dispatch("formLoaded"),this.modal.show(),e)).catch(d.default.exception)}setupFormSubmission(t,o){t.getRoot().on("submit","form",e=>{e.preventDefault();e=e.target,e=new FormData(e);let a={courseid:this.courseid};e.forEach((e,t)=>{a[t]=e}),t.setBody('<div class="text-center p-5"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>'),s.default.loadFragment("aiplacement_modgen","form_".concat(o),this.contextid,a).then(e=>(t.setBody(e),-1===e.indexOf("alert-success")&&this.setupFormSubmission(t,o),e)).catch(d.default.exception)})}showGeneratorLink(e){var t=M.cfg.wwwroot+"/ai/placement/modgen/prompt.php?id="+this.courseid;o.default.create({title:e,body:'<div class="text-center p-4"><p>Click the button below to open the Module Generator form.</p><a href="'+t+'" class="btn btn-primary btn-lg">Open Module Generator</a></div>',large:!1}).then(e=>(this.modal=e,this.modal.getRoot().on(i.default.hidden,()=>{this.reactive.dispatch("closeModal")}),this.modal.show(),e)).catch(d.default.exception)}open(){this.reactive.dispatch("openModal")}openWithForm(e,t){this.reactive.dispatch("openModalWithForm",e,t)}close(){this.reactive.dispatch("closeModal")}}e.init=(e,t)=>new c({element:document.body,reactive:r,courseid:e,contextid:t})});