/*! aiplacement_modgen - v1.0.0 - 2025-11-19
 * @license GPL-3.0-or-later or later
 */
define(["exports","core/reactive","core/event_dispatcher","core/fragment","aiplacement_modgen/modal","core/notification","core/modal_events"],function(e,t,a,o,s,d,i){function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0}),e.init=void 0,o=n(o),s=n(s),d=n(d),i=n(i);let l={stateChanged:"aiplacement_modgen/statechanged"};let r=new t.Reactive({name:"ModalGenerator",eventName:l.stateChanged,eventDispatch:(e,t)=>(0,a.dispatchEvent)(l.stateChanged,e,t),state:{modal:{isOpen:!1,isLoading:!1,formName:null,title:""},form:{isValid:!1,isDirty:!1,isSubmitting:!1}},mutations:new class{openModalWithForm(e,t,a){e.setReadOnly(!1),e.state.modal.isOpen=!0,e.state.modal.isLoading=!0,e.state.modal.formName=t,e.state.modal.title=a,e.setReadOnly(!0)}openModal(e){e.setReadOnly(!1),e.state.modal.isOpen=!0,e.state.modal.isLoading=!0,e.state.modal.formName=null,e.state.modal.title="Module Generator",e.setReadOnly(!0)}closeModal(e){e.setReadOnly(!1),e.state.modal.isOpen=!1,e.state.modal.isLoading=!1,e.state.modal.formName=null,e.state.modal.title="",e.setReadOnly(!0)}formLoaded(e){e.setReadOnly(!1),e.state.modal.isLoading=!1,e.setReadOnly(!0)}}});class c extends t.BaseComponent{create(e){this.courseid=e.courseid,this.contextid=e.contextid,this.modal=null}stateReady(){}getWatchers(){return[{watch:"modal.isOpen:updated",handler:this.handleModalStateChange},{watch:"modal.isLoading:updated",handler:this.handleLoadingChange}]}handleModalStateChange(e){e=e.state;e.modal.isOpen&&!this.modal?this.createModal():!e.modal.isOpen&&this.modal?(this.modal.destroy(),this.modal=null):e.modal.isOpen&&this.modal&&this.modal.show()}handleLoadingChange(e){e=e.state;this.modal&&e.modal.isLoading&&this.modal.setBody('<div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>')}createModal(){var e=this.reactive.state.modal.formName,t=this.reactive.state.modal.title||"Module Generator";e?this.loadFormInModal(e,t):this.showGeneratorLink(t)}loadFormInModal(t,a){o.default.loadFragment("aiplacement_modgen","form_".concat(t),this.contextid,{courseid:this.courseid}).then(e=>s.default.create({title:a,body:e,large:!1})).then(e=>(this.modal=e,this.modal.getRoot().on(i.default.hidden,()=>{this.reactive.dispatch("closeModal")}),this.setupFormSubmission(e,t),this.reactive.dispatch("formLoaded"),this.modal.show(),e)).catch(d.default.exception)}setupFormSubmission(o,s){o.getRoot().on("submit","form",e=>{e.preventDefault();var e=e.target,e=new FormData(e),t="add_theme"===s?"create_themes":"create_weeks";let a={courseid:this.courseid,sesskey:M.cfg.sesskey};e.forEach((e,t)=>{t.startsWith("_qf__")||"submitbutton"===t||"courseid"===t||"action"===t||(a[t]=e)}),a.action=t,o.setBody('<div class="text-center p-5"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>'),fetch(M.cfg.wwwroot+"/ai/placement/modgen/ajax/create_sections.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(a)}).then(e=>e.json()).then(e=>{if(e.success){let t='<div class="alert alert-success">';t+="<p>"+e.message+"</p>",e.messages&&0<e.messages.length&&(t+="<ul>",e.messages.forEach(e=>{t+="<li>"+e+"</li>"}),t+="</ul>");var a=M.cfg.wwwroot+"/course/view.php?id="+this.courseid;t=(t=(t=t+'<p class="mt-3">'+('<a href="'+a+'" class="btn btn-primary">'))+M.util.get_string("returntocourseview","aiplacement_modgen")+"</a>")+"</p>"+"</div>",o.setBody(t)}else{a='<div class="alert alert-danger"><p>'+(e.error||"An error occurred")+"</p></div>";o.setBody(a)}return e}).catch(e=>{d.default.exception(e)})})}showGeneratorLink(e){var t=M.cfg.wwwroot+"/ai/placement/modgen/prompt.php?id="+this.courseid;s.default.create({title:e,body:'<div class="text-center p-4"><p>Click the button below to open the Module Generator form.</p><a href="'+t+'" class="btn btn-primary btn-lg">Open Module Generator</a></div>',large:!1}).then(e=>(this.modal=e,this.modal.getRoot().on(i.default.hidden,()=>{this.reactive.dispatch("closeModal")}),this.modal.show(),e)).catch(d.default.exception)}open(){this.reactive.dispatch("openModal")}openWithForm(e,t){this.reactive.dispatch("openModalWithForm",e,t)}close(){this.reactive.dispatch("closeModal")}}e.init=(e,t)=>new c({element:document.body,reactive:r,courseid:e,contextid:t})});