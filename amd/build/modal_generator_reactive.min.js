/*! aiplacement_modgen - v1.0.0 - 2025-11-17
 * @license GPL-3.0-or-later or later
 */
define(["exports","core/reactive","core/event_dispatcher","core/templates","aiplacement_modgen/modal","core/notification"],function(e,t,a,o,s,d){function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0}),e.init=void 0,o=n(o),s=n(s),d=n(d);let i={stateChanged:"aiplacement_modgen/statechanged"};let r=new t.Reactive({name:"ModalGenerator",eventName:i.stateChanged,eventDispatch:(e,t)=>(0,a.dispatchEvent)(i.stateChanged,e,t),state:{modal:{isOpen:!1,isLoading:!1},form:{isValid:!1,isDirty:!1,isSubmitting:!1}},mutations:new class{openModal(e){e.setReadOnly(!1),e.state.modal.isOpen=!0,e.state.modal.isLoading=!0,e.setReadOnly(!0)}closeModal(e){e.setReadOnly(!1),e.state.modal.isOpen=!1,e.state.modal.isLoading=!1,e.setReadOnly(!0)}formLoaded(e){e.setReadOnly(!1),e.state.modal.isLoading=!1,e.setReadOnly(!0)}}});class l extends t.BaseComponent{create(e){this.courseid=e.courseid,this.contextid=e.contextid,this.modal=null}stateReady(){}getWatchers(){return[{watch:"modal.isOpen:updated",handler:this.handleModalStateChange},{watch:"modal.isLoading:updated",handler:this.handleLoadingChange}]}handleModalStateChange(e){e=e.state;e.modal.isOpen&&!this.modal?this.createModal():!e.modal.isOpen&&this.modal?(this.modal.destroy(),this.modal=null):e.modal.isOpen&&this.modal&&this.modal.show()}handleLoadingChange(e){e=e.state;this.modal&&e.modal.isLoading&&this.modal.setBody('<div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>')}createModal(){s.default.create({title:"Module Generator",body:'<div class="d-flex justify-content-center p-5"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>',large:!0}).then(e=>(this.modal=e,this.modal.show(),this.loadForm(),e)).catch(d.default.exception)}loadForm(){var e=M.cfg.wwwroot+"/ai/placement/modgen/generate.php",t=new URLSearchParams({courseid:this.courseid,sesskey:M.cfg.sesskey});fetch(e+"?"+t.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(t=>{if(t.success){var e;if(t.html)return e=this.modal.getBody()[0],o.default.replaceNodeContents(e,t.html,t.javascript||""),new Promise(e=>{setTimeout(()=>{this.reactive.dispatch("formLoaded"),e()},200)});throw new Error("No HTML returned from server")}{let e='<div class="alert alert-danger"><h4>Error loading form</h4>';e+="<p><strong>Error:</strong> "+(t.error||"Unknown error")+"</p>",t.file&&(e+="<p><strong>File:</strong> "+t.file+":"+t.line+"</p>"),t.trace&&(e+="<details><summary>Stack Trace</summary><pre>"+(Array.isArray(t.trace)?t.trace.join("\n"):t.trace)+"</pre></details>"),e+="</div>",this.modal.setBody(e),void console.error("Form load error:",t)}}).catch(e=>{this.modal.setBody('<div class="alert alert-danger">Error loading form: '+e.message+"</div>"),d.default.exception(e)})}open(){this.reactive.dispatch("openModal")}close(){this.reactive.dispatch("closeModal")}}e.init=(e,t)=>new l({element:document.body,reactive:r,courseid:e,contextid:t})});