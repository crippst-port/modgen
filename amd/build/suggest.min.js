/*! aiplacement_modgen - v1.0.0 - 2025-11-28
 * @license GPL-3.0-or-later or later
 */
define(["exports","core/notification","jquery"],function(e,l,o){function t(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,l=t(l),o=t(o);let a=M.cfg.wwwroot+"/ai/placement/modgen/ajax/suggest.php",c=M.cfg.wwwroot+"/ai/placement/modgen/ajax/suggest_create.php";e.default={init(e,s){e=e.getRoot();let r=e.find("#suggest-section-select"),t=e.find("#suggest-loading"),d=e.find("#suggest-results"),i=e.find("#suggest-create-selected"),n=e=>{t&&t.length&&t.toggle(e)};e.on("click","#suggest-scan-btn",e=>{e.preventDefault();var e=r.val(),t=(n(!0),d.empty(),i.prop("disabled",!0),new URLSearchParams);t.append("courseid",s),t.append("section",e),t.append("sesskey",M.cfg.sesskey),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}).then(e=>e.text()).then(t=>{n(!1);let e;try{e=JSON.parse(t)}catch(e){l.default.exception(new Error("Invalid JSON response from server")),console.error("Suggest endpoint returned non-JSON:",t);try{var a,s=JSON.parse(t.replace(/^\s+/,""));s&&s.debug_extra_base64&&(a=atob(s.debug_extra_base64),console.error("Decoded debug_extra_base64:",a))}catch(e){}return}if(e.success){t=e.suggestions||[];if(d.empty(),t.length){let n=(0,o.default)("<div/>").addClass("list-group");t.forEach(e=>{var t=e.id||"",a=(0,o.default)("<div/>").addClass("list-group-item"),t=(0,o.default)("<input/>").attr("type","checkbox").addClass("mr-2 suggest-checkbox").val(t),s=(!1!==e.supported&&t.prop("checked",!0),e.activity&&e.activity.name?e.activity.name:"Activity"),r=e.activity&&e.activity.type?e.activity.type:"?",s=(0,o.default)("<strong/>").text(s+" ("+r+")"),r=(!1===e.supported&&(r=e.raw_type||r||"",r=(0,o.default)("<span/>").addClass("badge badge-warning ml-2").attr("title",r).text(M.util.get_string("unsupported_label","aiplacement_modgen")||"Unsupported"),s.append(r)),(0,o.default)("<p/>").addClass("mb-0 small text-muted").text(e.rationale||""));a.append(t).append(s).append("<br/>").append(r),a.data("suggestion",e),n.append(a)}),d.append(n),i.prop("disabled",!1)}else d.append('<div class="alert alert-info">'+M.util.get_string("suggest_noresults","aiplacement_modgen")+"</div>"),i.prop("disabled",!0)}else l.default.exception(new Error(e.error||"No suggestions")),d.append('<div class="alert alert-danger">'+(e.error||"Error fetching suggestions")+"</div>")}).catch(e=>{n(!1),l.default.exception(e)})}),e.on("click","#suggest-create-selected",e=>{e.preventDefault();let a=[];d.find(".list-group-item").each(function(){var e=(0,o.default)(this),t=e.find("input.suggest-checkbox");t.length&&t.prop("checked")&&(t=e.data("suggestion"))&&a.push(t)}),0===a.length?l.default.exception(new Error("No items selected")):((e=new URLSearchParams).append("courseid",s),e.append("section",r.val()),e.append("selected",JSON.stringify(a)),e.append("sesskey",M.cfg.sesskey),n(!0),fetch(c,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}).then(e=>e.json()).then(e=>{if(n(!1),e.success){let t='<div class="alert alert-success">Created '+(e.created?e.created.length:0)+" activities.</div>";e.created&&e.created.length&&(t+='<ul class="mt-2">',e.created.forEach(e=>{t+="<li>"+(0,o.default)("<div/>").text(e).html()+"</li>"}),t+="</ul>"),e.warnings&&e.warnings.length&&(t+='<div class="alert alert-warning mt-2"><strong>'+(M.util.get_string("creation_warnings","aiplacement_modgen")||"Warnings")+":</strong><ul>",e.warnings.forEach(e=>{t+="<li>"+(0,o.default)("<div/>").text(e).html()+"</li>"}),t+="</ul></div>"),d.html(t),i.prop("disabled",!0)}else if(l.default.exception(new Error(e.error||"Creation failed")),d.append('<div class="alert alert-danger">'+(e.error||"Creation failed")+"</div>"),e.debug_extra_base64)try{var t=atob(e.debug_extra_base64);d.append('<pre class="mt-2">'+(0,o.default)("<div/>").text(t).html()+"</pre>")}catch(e){}}).catch(e=>{n(!1),l.default.exception(e)}))})}}});