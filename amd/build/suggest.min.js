/*! aiplacement_modgen - v1.0.0 - 2025-11-28
 * @license GPL-3.0-or-later or later
 */
define(["exports","core/notification","jquery"],function(e,c,p){function t(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,c=t(c),p=t(p);let a=M.cfg.wwwroot+"/ai/placement/modgen/ajax/suggest.php",u=M.cfg.wwwroot+"/ai/placement/modgen/ajax/suggest_create.php";e.default={init(e,i){let l={acquisition:"rgba(66, 139, 202, 0.9)",inquiry:"rgba(255, 152, 0, 0.9)",practice:"rgba(255, 193, 7, 0.9)",discussion:"rgba(40, 167, 69, 0.9)",collaboration:"rgba(75, 192, 192, 0.9)",production:"rgba(220, 53, 69, 0.9)"};e=e.getRoot();let s=e.find("#suggest-section-select"),t=e.find("#suggest-loading"),n=e.find("#suggest-results"),o=e.find("#suggest-create-selected"),d=e=>{t&&t.length&&t.toggle(e)};e.on("click","#suggest-scan-btn",e=>{e.preventDefault();var e=s.val(),t=(d(!0),n.empty(),o.prop("disabled",!0),new URLSearchParams);t.append("courseid",i),t.append("section",e),t.append("sesskey",M.cfg.sesskey),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}).then(e=>e.text()).then(t=>{d(!1);let e;try{e=JSON.parse(t)}catch(e){c.default.exception(new Error("Invalid JSON response from server")),console.error("Suggest endpoint returned non-JSON:",t);try{var a,r=JSON.parse(t.replace(/^\s+/,""));r&&r.debug_extra_base64&&(a=atob(r.debug_extra_base64),console.error("Decoded debug_extra_base64:",a))}catch(e){}return}if(e.success){t=e.suggestions||[];if(n.empty(),t.length){let d=(0,p.default)("<div/>").addClass("list-group");t.forEach(e=>{var t=e.id||"",a=(0,p.default)("<div/>").addClass("list-group-item"),t=(0,p.default)("<input/>").attr("type","checkbox").addClass("mr-2 suggest-checkbox").val(t),r=(!1!==e.supported&&t.prop("checked",!0),e.activity&&e.activity.name?e.activity.name:"Activity"),i=e.activity&&e.activity.type?e.activity.type:"?",r=(0,p.default)("<strong/>").text(r+" ("+i+")"),s=e.laurillard_type||e.laurillardType||"",i=(s&&(n=String(s).toLowerCase().trim(),n=l[n]||null,s=(0,p.default)("<span/>").addClass("ml-2").attr("title",s).text(s),n?s.css({"background-color":n,color:"#fff",padding:"0.25em 0.5em","border-radius":"0.25rem","font-size":"0.75em"}):s.addClass("badge badge-info"),r.append(s)),!1===e.supported&&(n=e.raw_type||i||"",s=(0,p.default)("<span/>").addClass("badge badge-warning ml-2").attr("title",n).text(M.util.get_string("unsupported_label","aiplacement_modgen")||"Unsupported"),r.append(s)),(0,p.default)("<p/>").addClass("mb-0 small text-muted").text(e.rationale||"")),n=e.laurillard_rationale||e.laurillardRationale||"",s=n?(0,p.default)("<p/>").addClass("mb-0 small font-italic text-muted").text(n):(0,p.default)();a.append(t).append(r).append("<br/>").append(i).append(s),a.data("suggestion",e),d.append(a)}),n.append(d),o.prop("disabled",!1)}else n.append('<div class="alert alert-info">'+M.util.get_string("suggest_noresults","aiplacement_modgen")+"</div>"),o.prop("disabled",!0)}else c.default.exception(new Error(e.error||"No suggestions")),n.append('<div class="alert alert-danger">'+(e.error||"Error fetching suggestions")+"</div>")}).catch(e=>{d(!1),c.default.exception(e)})}),e.on("click","#suggest-create-selected",e=>{e.preventDefault();let a=[],r=[];n.find(".list-group-item").each(function(){var e=(0,p.default)(this),t=e.find("input.suggest-checkbox");t.length&&t.prop("checked")&&(t=e.data("suggestion"))&&(e=t.activity&&t.activity.type?String(t.activity.type).trim():"",!1===t.supported||""===e||"?"===e?r.push(t.activity&&(t.activity.name||t.activity.type)?t.activity.name||t.activity.type:"(unknown)"):a.push(t))}),0===a.length?r.length?c.default.exception(new Error("Some selected items were skipped because their activity type is unsupported or unknown: "+r.join(", "))):c.default.exception(new Error("No items selected")):((e=new URLSearchParams).append("courseid",i),e.append("section",s.val()),e.append("selected",JSON.stringify(a)),e.append("sesskey",M.cfg.sesskey),d(!0),fetch(u,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}).then(e=>e.json()).then(e=>{if(d(!1),e.success){let t='<div class="alert alert-success">Created '+(e.created?e.created.length:0)+" activities.</div>";e.created&&e.created.length&&(t+='<ul class="mt-2">',e.created.forEach(e=>{t+="<li>"+(0,p.default)("<div/>").text(e).html()+"</li>"}),t+="</ul>"),e.warnings&&e.warnings.length&&(t+='<div class="alert alert-warning mt-2"><strong>'+(M.util.get_string("creation_warnings","aiplacement_modgen")||"Warnings")+":</strong><ul>",e.warnings.forEach(e=>{t+="<li>"+(0,p.default)("<div/>").text(e).html()+"</li>"}),t+="</ul></div>"),n.html(t),o.prop("disabled",!0)}else if(c.default.exception(new Error(e.error||"Creation failed")),n.append('<div class="alert alert-danger">'+(e.error||"Creation failed")+"</div>"),e.debug_extra_base64)try{var t=atob(e.debug_extra_base64);n.append('<pre class="mt-2">'+(0,p.default)("<div/>").text(t).html()+"</pre>")}catch(e){}}).catch(e=>{d(!1),c.default.exception(e)}))})}}});