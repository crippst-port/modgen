/*! aiplacement_modgen - v1.0.0 - 2025-11-28
 * @license GPL-3.0-or-later or later
 */
define(["exports","core/notification","jquery"],function(e,h,f){function t(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,h=t(h),f=t(f);let y=M.cfg.wwwroot+"/ai/placement/modgen/ajax/suggest.php",b=M.cfg.wwwroot+"/ai/placement/modgen/ajax/suggest_create.php";e.default={init(e,s){let o={acquisition:"rgba(66, 139, 202, 0.9)",inquiry:"rgba(255, 152, 0, 0.9)",practice:"rgba(255, 193, 7, 0.9)",discussion:"rgba(40, 167, 69, 0.9)",collaboration:"rgba(75, 192, 192, 0.9)",production:"rgba(220, 53, 69, 0.9)"},d=e.getRoot();try{var t=d.closest(".modal-dialog");if(t&&t.length){try{t.removeClass(function(e,t){return(t||"").split(/\s+/).filter(function(e){return/^modal-/.test(e)}).join(" ")})}catch(e){t.removeClass("modal-sm modal-lg modal-xl modal-xxl modal-fullscreen modal-fullscreen-sm-down modal-fullscreen-md-down modal-fullscreen-lg-down")}t.addClass("aiplacement-modgen-xxl")}}catch(e){}let i=d.find("#suggest-section-select"),a=d.find("#suggest-loading"),c=d.find("#suggest-results"),u=d.find("#suggest-create-selected"),n=e=>{a&&a.length&&a.toggle(e)},r=null,p=null,g=null,m=e=>{if(e&&e.labels){p=p||{labels:e.labels.slice(),data:e.data.slice(),colors:e.colors.slice()};let l={labels:e.labels.slice(),data:e.data.slice(),colors:e.colors.slice()};require(["jquery","core/chartjs"],function(i,e){var t=document.getElementById("suggest-learning-types-chart");if(t){t=t.getContext("2d");if(r)try{r.data.labels=l.labels,r.data.datasets&&r.data.datasets.length?(r.data.datasets[0].data=l.data,r.data.datasets[0].backgroundColor=l.colors):r.data.datasets=[{data:l.data,backgroundColor:l.colors,borderColor:"#fff",borderWidth:2}],r.options&&(r.options.animation={duration:400,easing:"easeOutQuart"}),r.update()}catch(e){try{r.destroy()}catch(e){}r=null}if(!r){var a={type:"pie",data:{labels:l.labels,datasets:[{data:l.data,backgroundColor:l.colors,borderColor:"#fff",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!1}},animation:{duration:400,easing:"easeOutQuart"}}};try{r=new Chart(t,a)}catch(e){console.error("Chart render failed",e)}}let s=i("#suggest-learning-types-legend");s.empty(),l.labels.forEach((e,t)=>{var a=l.colors[t]||"#ccc",t=l.data[t]||0,r=i("<div/>").addClass("mb-1"),a=i("<span/>").css({display:"inline-block",width:"12px",height:"12px","background-color":a,"margin-right":"8px","vertical-align":"middle"});r.append(a).append(document.createTextNode(" "+e+": "+t)),s.append(r)})}})}};try{var l=d.closest(".modal");l&&l.length&&l.on("hidden.bs.modal",function(){var e=d.closest(".modal-dialog");if(e&&e.length){e.removeClass("aiplacement-modgen-xxl");try{e.each(function(){this.style.removeProperty("max-width")})}catch(e){}}})}catch(e){}d.on("click","#suggest-scan-btn",e=>{e.preventDefault();var e=i.val(),t=(n(!0),c.empty(),d.find("#suggest-summary").hide(),u.prop("disabled",!0),new URLSearchParams);t.append("courseid",s),t.append("section",e),t.append("sesskey",M.cfg.sesskey),fetch(y,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}).then(e=>e.text()).then(a=>{n(!1);let e;try{e=JSON.parse(a)}catch(e){h.default.exception(new Error("Invalid JSON response from server")),console.error("Suggest endpoint returned non-JSON:",a);try{var t,r=JSON.parse(a.replace(/^\s+/,""));r&&r.debug_extra_base64&&(t=atob(r.debug_extra_base64),console.error("Decoded debug_extra_base64:",t))}catch(e){}return}if(e.success){a=e.suggestions||[];if(e.current_learning_types?(p={labels:e.current_learning_types.labels||[],data:e.current_learning_types.data||[],colors:e.current_learning_types.colors||[]},m(p)):p=null,c.empty(),a.length){let n=(0,f.default)("<div/>").addClass("list-group");a.forEach(e=>{var t=e.id||"",a=(0,f.default)("<div/>").addClass("list-group-item"),t=(0,f.default)("<input/>").attr("type","checkbox").addClass("mr-2 suggest-checkbox").val(t),r=e.activity&&e.activity.name?e.activity.name:"Activity",s=e.activity&&e.activity.type?e.activity.type:"?",r=(0,f.default)("<strong/>").text(r+" ("+s+")"),i=e.laurillard_type||e.laurillardType||"",s=(i&&(l=String(i).toLowerCase().trim(),l=o[l]||null,i=(0,f.default)("<span/>").addClass("ml-2").attr("title",i).text(i),l?i.css({"background-color":l,color:"#fff",padding:"0.25em 0.5em","border-radius":"0.25rem","font-size":"0.75em"}):i.addClass("badge badge-info"),r.append(i)),!1===e.supported&&(l=e.raw_type||s||"",i=(0,f.default)("<span/>").addClass("badge badge-warning ml-2").attr("title",l).text(M.util.get_string("unsupported_label","aiplacement_modgen")||"Unsupported"),r.append(i)),(0,f.default)("<p/>").addClass("mb-0 small text-muted").text(e.rationale||"")),l=e.laurillard_rationale||e.laurillardRationale||"",i=l?(0,f.default)("<p/>").addClass("mb-0 small font-italic text-muted").text(l):(0,f.default)();a.append(t).append(r).append("<br/>").append(s).append(i),a.data("suggestion",e),n.append(a)}),c.append(n),d.find("#suggest-summary").show();try{var s=d.closest(".modal-dialog");s&&s.length&&s.each(function(){try{this.style.setProperty("max-width","1200px","important")}catch(e){}})}catch(e){}let t=()=>{g&&clearTimeout(g),g=setTimeout(()=>{(()=>{if(p){let r=p.data.slice(),s=p.labels;c.find(".list-group-item").each(function(){var e=(0,f.default)(this),t=e.find("input.suggest-checkbox");if(t.length&&t.prop("checked")){var t=e.data("suggestion");if(t){const a=(t.laurillard_type||t.laurillardType||"").toString().trim().toLowerCase();a||(e={page:"acquisition",book:"acquisition",resource:"acquisition",label:"acquisition",url:"acquisition",forum:"discussion",chat:"discussion",choice:"inquiry",survey:"inquiry",workshop:"inquiry",lesson:"practice",feedback:"practice",assign:"production",assignment:"production",quiz:"production",scorm:"production",bigbluebuttonbn:"collaboration",zoom:"collaboration"}[t.activity&&t.activity.type?t.activity.type.toString().toLowerCase():""]||"")&&(a=e),a&&0<=(t=s.findIndex(e=>e.toString().toLowerCase()===a))&&(r[t]=(r[t]||0)+1)}}});var e={labels:p.labels,data:r,colors:p.colors};m(e)}})(),g=null},150)};c.find("input.suggest-checkbox").on("change",function(){t();var e=0<c.find("input.suggest-checkbox:checked").length;u.prop("disabled",!e)}),t(),u.prop("disabled",!0)}else{c.append('<div class="alert alert-info">'+M.util.get_string("suggest_noresults","aiplacement_modgen")+"</div>"),u.prop("disabled",!0),d.find("#suggest-summary").hide();try{var i=d.closest(".modal-dialog");i&&i.length&&i.each(function(){try{this.style.removeProperty("max-width")}catch(e){}})}catch(e){}}}else{h.default.exception(new Error(e.error||"No suggestions")),c.append('<div class="alert alert-danger">'+(e.error||"Error fetching suggestions")+"</div>"),d.find("#suggest-summary").hide();try{var l=d.closest(".modal-dialog");l&&l.length&&l.each(function(){try{this.style.removeProperty("max-width")}catch(e){}})}catch(e){}}}).catch(e=>{n(!1),h.default.exception(e),d.find("#suggest-summary").hide();try{var t=d.closest(".modal-dialog");t&&t.length&&t.each(function(){try{this.style.removeProperty("max-width")}catch(e){}})}catch(e){}})}),d.on("click","#suggest-create-selected",e=>{e.preventDefault();let a=[],r=[];c.find(".list-group-item").each(function(){var e=(0,f.default)(this),t=e.find("input.suggest-checkbox");t.length&&t.prop("checked")&&(t=e.data("suggestion"))&&(e=t.activity&&t.activity.type?String(t.activity.type).trim():"",!1===t.supported||""===e||"?"===e?r.push(t.activity&&(t.activity.name||t.activity.type)?t.activity.name||t.activity.type:"(unknown)"):a.push(t))}),0===a.length?r.length?h.default.exception(new Error("Some selected items were skipped because their activity type is unsupported or unknown: "+r.join(", "))):h.default.exception(new Error("No items selected")):((e=new URLSearchParams).append("courseid",s),e.append("section",i.val()),e.append("selected",JSON.stringify(a)),e.append("sesskey",M.cfg.sesskey),n(!0),fetch(b,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}).then(e=>e.json()).then(e=>{if(n(!1),e.success){let t='<div class="alert alert-success">Created '+(e.created?e.created.length:0)+" activities.</div>";e.created&&e.created.length&&(t+='<ul class="mt-2">',e.created.forEach(e=>{t+="<li>"+(0,f.default)("<div/>").text(e).html()+"</li>"}),t+="</ul>"),e.warnings&&e.warnings.length&&(t+='<div class="alert alert-warning mt-2"><strong>'+(M.util.get_string("creation_warnings","aiplacement_modgen")||"Warnings")+":</strong><ul>",e.warnings.forEach(e=>{t+="<li>"+(0,f.default)("<div/>").text(e).html()+"</li>"}),t+="</ul></div>"),c.html(t),d.find("#suggest-summary").hide();try{var a=d.closest(".modal-dialog");a&&a.length&&a.each(function(){try{this.style.removeProperty("max-width")}catch(e){}})}catch(e){}u.prop("disabled",!0)}else if(h.default.exception(new Error(e.error||"Creation failed")),c.append('<div class="alert alert-danger">'+(e.error||"Creation failed")+"</div>"),e.debug_extra_base64)try{var t=atob(e.debug_extra_base64);c.append('<pre class="mt-2">'+(0,f.default)("<div/>").text(t).html()+"</pre>")}catch(e){}}).catch(e=>{n(!1),h.default.exception(e)}))})}}});