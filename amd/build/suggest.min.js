/*! aiplacement_modgen - v1.0.0 - 2025-11-28
 * @license GPL-3.0-or-later or later
 */
define(["exports","core/notification","core/config","jquery"],function(e,h,b,y){function t(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,h=t(h),b=t(b),y=t(y);e.default={init(e,l){let a=b.default.wwwroot+"/ai/placement/modgen/ajax/suggest.php",t=b.default.wwwroot+"/ai/placement/modgen/ajax/suggest_create.php",o={acquisition:"rgba(66, 139, 202, 0.9)",inquiry:"rgba(255, 152, 0, 0.9)",practice:"rgba(255, 193, 7, 0.9)",discussion:"rgba(40, 167, 69, 0.9)",collaboration:"rgba(75, 192, 192, 0.9)",production:"rgba(220, 53, 69, 0.9)"},i=e.getRoot();try{var s=i.closest(".modal-dialog");if(s&&s.length){try{s.removeClass(function(e,t){return(t||"").split(/\s+/).filter(function(e){return/^modal-/.test(e)}).join(" ")})}catch(e){s.removeClass("modal-sm modal-lg modal-xl modal-xxl modal-fullscreen modal-fullscreen-sm-down modal-fullscreen-md-down modal-fullscreen-lg-down")}s.addClass("aiplacement-modgen-xxl")}}catch(e){}let r=i.find("#suggest-section-select"),n=i.find("#suggest-loading"),d=i.find("#suggest-results"),c=i.find("#suggest-create-selected"),u=e=>{n&&n.length&&n.toggle(e)},p=null,g=null,m=null,f=e=>{if(e&&e.labels){g=g||{labels:e.labels.slice(),data:e.data.slice(),colors:e.colors.slice()};let r={labels:e.labels.slice(),data:e.data.slice(),colors:e.colors.slice()};require(["jquery","core/chartjs"],function(i,e){var t=document.getElementById("suggest-learning-types-chart");if(t){t=t.getContext("2d");if(p)try{p.data.labels=r.labels,p.data.datasets&&p.data.datasets.length?(p.data.datasets[0].data=r.data,p.data.datasets[0].backgroundColor=r.colors):p.data.datasets=[{data:r.data,backgroundColor:r.colors,borderColor:"#fff",borderWidth:2}],p.options&&(p.options.animation={duration:400,easing:"easeOutQuart"}),p.update()}catch(e){try{p.destroy()}catch(e){}p=null}if(!p){var a={type:"pie",data:{labels:r.labels,datasets:[{data:r.data,backgroundColor:r.colors,borderColor:"#fff",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!1}},animation:{duration:400,easing:"easeOutQuart"}}};try{p=new Chart(t,a)}catch(e){console.error("Chart render failed",e)}}let l=i("#suggest-learning-types-legend");l.empty(),r.labels.forEach((e,t)=>{var a=r.colors[t]||"#ccc",t=r.data[t]||0,s=i("<div/>").addClass("mb-1"),a=i("<span/>").css({display:"inline-block",width:"12px",height:"12px","background-color":a,"margin-right":"8px","vertical-align":"middle"});s.append(a).append(document.createTextNode(" "+e+": "+t)),l.append(s)})}})}};try{let e=i.closest(".modal");e&&e.length&&e.on("hidden.bs.modal",function(){e.removeClass("aiplacement-modgen-modal-wide")})}catch(e){}i.on("click","#suggest-scan-btn",e=>{e.preventDefault();var e=r.val(),t=(u(!0),d.empty(),i.find("#suggest-summary").hide(),c.prop("disabled",!0),new URLSearchParams);t.append("courseid",l),t.append("section",e),t.append("sesskey",b.default.sesskey),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}).then(e=>e.text()).then(a=>{u(!1);let e;try{e=JSON.parse(a)}catch(e){h.default.exception(new Error("Invalid JSON response from server")),console.error("Suggest endpoint returned non-JSON:",a);try{var t,s=JSON.parse(a.replace(/^\s+/,""));s&&s.debug_extra_base64&&(t=atob(s.debug_extra_base64),console.error("Decoded debug_extra_base64:",t))}catch(e){}return}if(e.success){a=e.suggestions||[];if(e.current_learning_types?(g={labels:e.current_learning_types.labels||[],data:e.current_learning_types.data||[],colors:e.current_learning_types.colors||[]},f(g)):g=null,d.empty(),a.length){let n=(0,y.default)("<div/>").addClass("list-group"),t=(a.forEach(e=>{var t=e.id||"",a=(0,y.default)("<div/>").addClass("list-group-item"),t=(0,y.default)("<input/>").attr("type","checkbox").addClass("mr-2 suggest-checkbox").val(t),s=e.activity&&e.activity.name?e.activity.name:"Activity",l=e.activity&&e.activity.type?e.activity.type:"?",s=(0,y.default)("<strong/>").text(s+" ("+l+")"),i=e.laurillard_type||e.laurillardType||"",l=(i&&(r=String(i).toLowerCase().trim(),r=o[r]||null,i=(0,y.default)("<span/>").addClass("ml-2").attr("title",i).text(i),r?i.css({"background-color":r,color:"#fff",padding:"0.25em 0.5em","border-radius":"0.25rem","font-size":"0.75em"}):i.addClass("badge badge-info"),s.append(i)),!1===e.supported&&(r=e.raw_type||l||"",i=(0,y.default)("<span/>").addClass("badge badge-warning ml-2").attr("title",r).text(M.util.get_string("unsupported_label","aiplacement_modgen")||"Unsupported"),s.append(i)),(0,y.default)("<p/>").addClass("mb-0 small text-muted").text(e.rationale||"")),r=e.laurillard_rationale||e.laurillardRationale||"",i=r?(0,y.default)("<p/>").addClass("mb-0 small font-italic text-muted").text(r):(0,y.default)();a.append(t).append(s).append("<br/>").append(l).append(i),a.data("suggestion",e),n.append(a)}),d.append(n),i.find("#suggest-summary").show(),i.closest(".modal").addClass("aiplacement-modgen-modal-wide"),()=>{m&&clearTimeout(m),m=setTimeout(()=>{(()=>{if(g){let s=g.data.slice(),l=g.labels;d.find(".list-group-item").each(function(){var e=(0,y.default)(this),t=e.find("input.suggest-checkbox");if(t.length&&t.prop("checked")){var t=e.data("suggestion");if(t){const a=(t.laurillard_type||t.laurillardType||"").toString().trim().toLowerCase();a||(e={page:"acquisition",book:"acquisition",resource:"acquisition",label:"acquisition",url:"acquisition",forum:"discussion",chat:"discussion",choice:"inquiry",survey:"inquiry",workshop:"inquiry",lesson:"practice",feedback:"practice",assign:"production",assignment:"production",quiz:"production",scorm:"production",bigbluebuttonbn:"collaboration",zoom:"collaboration"}[t.activity&&t.activity.type?t.activity.type.toString().toLowerCase():""]||"")&&(a=e),a&&0<=(t=l.findIndex(e=>e.toString().toLowerCase()===a))&&(s[t]=(s[t]||0)+1)}}});var e={labels:g.labels,data:s,colors:g.colors};f(e)}})(),m=null},150)});d.find("input.suggest-checkbox").on("change",function(){t();var e=0<d.find("input.suggest-checkbox:checked").length;c.prop("disabled",!e)}),t(),c.prop("disabled",!0)}else d.append('<div class="alert alert-info">'+M.util.get_string("suggest_noresults","aiplacement_modgen")+"</div>"),c.prop("disabled",!0),i.find("#suggest-summary").hide(),i.closest(".modal").removeClass("aiplacement-modgen-modal-wide")}else h.default.exception(new Error(e.error||"No suggestions")),d.append('<div class="alert alert-danger">'+(e.error||"Error fetching suggestions")+"</div>"),i.find("#suggest-summary").hide(),i.closest(".modal").removeClass("aiplacement-modgen-modal-wide")}).catch(e=>{u(!1),h.default.exception(e),i.find("#suggest-summary").hide(),i.closest(".modal").removeClass("aiplacement-modgen-modal-wide")})}),i.on("click","#suggest-create-selected",e=>{e.preventDefault();let a=[],s=[];d.find(".list-group-item").each(function(){var e=(0,y.default)(this),t=e.find("input.suggest-checkbox");t.length&&t.prop("checked")&&(t=e.data("suggestion"))&&(e=t.activity&&t.activity.type?String(t.activity.type).trim():"",!1===t.supported||""===e||"?"===e?s.push(t.activity&&(t.activity.name||t.activity.type)?t.activity.name||t.activity.type:"(unknown)"):a.push(t))}),0===a.length?s.length?h.default.exception(new Error("Some selected items were skipped because their activity type is unsupported or unknown: "+s.join(", "))):h.default.exception(new Error("No items selected")):((e=new URLSearchParams).append("courseid",l),e.append("section",r.val()),e.append("selected",JSON.stringify(a)),e.append("sesskey",b.default.sesskey),u(!0),fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}).then(e=>e.json()).then(e=>{if(u(!1),e.success){let t='<div class="alert alert-success">Created '+(e.created?e.created.length:0)+" activities.</div>";e.created&&e.created.length&&(t+='<ul class="mt-2">',e.created.forEach(e=>{t+="<li>"+(0,y.default)("<div/>").text(e).html()+"</li>"}),t+="</ul>"),e.warnings&&e.warnings.length&&(t+='<div class="alert alert-warning mt-2"><strong>'+(M.util.get_string("creation_warnings","aiplacement_modgen")||"Warnings")+":</strong><ul>",e.warnings.forEach(e=>{t+="<li>"+(0,y.default)("<div/>").text(e).html()+"</li>"}),t+="</ul></div>"),d.html(t),i.find("#suggest-summary").hide(),i.closest(".modal").removeClass("aiplacement-modgen-modal-wide"),c.prop("disabled",!0)}else if(h.default.exception(new Error(e.error||"Creation failed")),d.append('<div class="alert alert-danger">'+(e.error||"Creation failed")+"</div>"),e.debug_extra_base64)try{var t=atob(e.debug_extra_base64);d.append('<pre class="mt-2">'+(0,y.default)("<div/>").text(t).html()+"</pre>")}catch(e){}}).catch(e=>{u(!1),h.default.exception(e)}))})}}});