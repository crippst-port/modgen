// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 * Reactive modal generator component.
 *
 * @module     aiplacement_modgen/modal_generator_reactive
 * @copyright  2025 Tom Cripps <tom.cripps@port.ac.uk>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */

import {BaseComponent} from 'core/reactive';
import {Reactive} from 'core/reactive';
import Modal from 'core/modal';
import Notification from 'core/notification';

/**
 * Reactive instance for the generator modal.
 */
let reactiveInstance = null;

/**
 * Get or create the reactive instance.
 *
 * @return {Object} The reactive instance
 */
const getReactiveInstance = () => {
    if (!reactiveInstance) {
        // eslint-disable-next-line no-console
        console.log('Module Generator Reactive: Creating reactive instance');
        reactiveInstance = new Reactive({
            eventName: 'aiplacement_modgen:statechanged',
            eventDispatch: (event) => {
                document.dispatchEvent(new CustomEvent(event.eventName, {detail: event}));
            },
        });

        // eslint-disable-next-line no-console
        console.log('Module Generator Reactive: Registering mutations');
        reactiveInstance.setMutations({
            /**
             * Open the modal.
             *
             * @param {Object} stateManager State manager
             */
            openModal: (stateManager) => {
                // eslint-disable-next-line no-console
                console.log('Module Generator Reactive: openModal mutation executing');
                stateManager.setReadOnly(false);
                stateManager.state.modal.isOpen = true;
                stateManager.state.modal.isLoading = true;
                stateManager.state.modal.loadingMessage = 'Loading form...';
                stateManager.setReadOnly(true);
            },

            /**
             * Close the modal.
             *
             * @param {Object} stateManager State manager
             */
            closeModal: (stateManager) => {
                stateManager.setReadOnly(false);
                stateManager.state.modal.isOpen = false;
                stateManager.state.modal.isLoading = false;
                stateManager.state.form.isDirty = false;
                stateManager.setReadOnly(true);
            },

            /**
             * Form loaded successfully.
             *
             * @param {Object} stateManager State manager
             */
            formLoaded: (stateManager) => {
                stateManager.setReadOnly(false);
                stateManager.state.modal.isLoading = false;
                stateManager.setReadOnly(true);
            },

            /**
             * Form is being submitted.
             *
             * @param {Object} stateManager State manager
             */
            submitForm: (stateManager) => {
                stateManager.setReadOnly(false);
                stateManager.state.form.isSubmitting = true;
                stateManager.state.modal.isLoading = true;
                stateManager.state.modal.loadingMessage = 'Generating module structure...';
                stateManager.setReadOnly(true);
            },

            /**
             * Form field changed.
             *
             * @param {Object} stateManager State manager
             */
            formChanged: (stateManager) => {
                stateManager.setReadOnly(false);
                stateManager.state.form.isDirty = true;
                stateManager.setReadOnly(true);
            },
        });

        // Set initial state
        // eslint-disable-next-line no-console
        console.log('Module Generator Reactive: Setting initial state');
        reactiveInstance.setInitialState({
            modal: {
                isOpen: false,
                isLoading: false,
                loadingMessage: '',
            },
            form: {
                isValid: false,
                isDirty: false,
                isSubmitting: false,
            },
        });
    }
    return reactiveInstance;
};

    /**
     * Modal Generator Component.
     *
     * @class
     */
    var ModalGeneratorComponent = class extends Reactive.BaseComponent {
        /**
         * Create the component.
         *
         * @param {Object} descriptor Component descriptor
         */
        create(descriptor) {
            this.courseid = descriptor.courseid;
            this.modal = null;
            this.formElement = null;
        }

        /**
         * Initial state ready.
         */
        stateReady() {
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: stateReady() called - component ready to interact with state');
            // Component is ready to interact with state
        }

        /**
         * Get state watchers.
         *
         * @return {Array} Watchers
         */
        getWatchers() {
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: getWatchers() called - registering watchers');
            return [
                {watch: 'modal.isOpen:updated', handler: this.handleModalStateChange},
                {watch: 'modal.isLoading:updated', handler: this.handleLoadingStateChange},
                {watch: 'form.isSubmitting:updated', handler: this.handleSubmittingStateChange},
            ];
        }

        /**
         * Handle modal state changes.
         *
         * @param {Object} param Watch parameters
         * @param {Object} param.state Current state
         */
        handleModalStateChange({state}) {
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: Modal state changed', state.modal);
            if (state.modal.isOpen && !this.modal) {
                // eslint-disable-next-line no-console
                console.log('Module Generator Reactive: Creating modal');
                this.createModal();
            } else if (!state.modal.isOpen && this.modal) {
                // eslint-disable-next-line no-console
                console.log('Module Generator Reactive: Destroying modal');
                this.modal.destroy();
                this.modal = null;
            }
        }

        /**
         * Handle loading state change.
         *
         * @param {Object} param Watch parameters
         * @param {Object} param.state Current state
         */
        handleLoadingStateChange({state}) {
            if (!this.modal) {
                return;
            }

            if (state.modal.isLoading) {
                var message = state.modal.loadingMessage || 'Loading...';
                var spinner = '<div class="modgen-loading text-center p-5">' +
                    '<div class="spinner-border text-primary mb-3" role="status">' +
                    '<span class="sr-only">Loading...</span></div>' +
                    '<p class="text-muted">' + message + '</p></div>';
                this.modal.setBody(spinner);
                this.locked = true;
            } else {
                this.locked = false;
            }
        }

        /**
         * Handle submitting state change.
         *
         * @param {Object} param Watch parameters
         * @param {Object} param.state Current state
         */
        handleSubmittingStateChange({state}) {
            if (this.formElement && state.form.isSubmitting) {
                // Disable all form inputs
                var inputs = this.formElement.querySelectorAll('input, select, textarea, button');
                inputs.forEach(function(input) {
                    input.disabled = true;
                });
            }
        }

        /**
         * Create and show the modal.
         */
        createModal() {
            var self = this;
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: Creating modal instance');
            Modal.create({
                title: 'Module Assistant',
                body: '<div class="text-center p-3"><div class="spinner-border"></div></div>',
                large: true,
                removeOnClose: true,
            })
            .then(function(modal) {
                // eslint-disable-next-line no-console
                console.log('Module Generator Reactive: Modal created, showing');
                self.modal = modal;
                modal.show();

                // Load form content
                return self.loadForm();
            })
            .then(function() {
                // eslint-disable-next-line no-console
                console.log('Module Generator Reactive: Form loaded, attaching close listener');
                // Listen for modal close
                self.modal.getRoot()[0].addEventListener('hidden.bs.modal', function() {
                    self.reactive.dispatch('closeModal');
                });
                return;
            })
            .catch(function(error) {
                // eslint-disable-next-line no-console
                console.error('Module Generator Reactive: Error creating modal', error);
                Notification.exception(error);
            });
        }

        /**
         * Load form via AJAX.
         *
         * @return {Promise} Promise that resolves when form is loaded
         */
        loadForm() {
            var self = this;
            var url = M.cfg.wwwroot + '/ai/placement/modgen/generate.php?courseid=' + this.courseid;

            return fetch(url, {
                method: 'GET',
                headers: {'Accept': 'application/json'},
                credentials: 'same-origin',
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success && data.html) {
                    self.modal.setBody(data.html);
                    self.reactive.dispatch('formLoaded');

                    // Setup form handlers after a short delay to ensure DOM is ready
                    setTimeout(function() {
                        self.setupFormHandlers();
                    }, 100);
                    return;
                }
                throw new Error('Failed to load form');
            })
            .catch(function(error) {
                Notification.exception(error);
                self.reactive.dispatch('closeModal');
            });
        }

        /**
         * Setup form event handlers.
         */
        setupFormHandlers() {
            var self = this;
            this.formElement = this.modal.getBody()[0].querySelector('form');
            if (!this.formElement) {
                return;
            }

            // Track form changes
            this.formElement.addEventListener('change', function() {
                self.reactive.dispatch('formChanged');
            });

            // Handle form submission
            this.formElement.addEventListener('submit', function(e) {
                e.preventDefault();
                self.reactive.dispatch('submitForm');

                var formData = new FormData(self.formElement);
                var url = self.formElement.action || M.cfg.wwwroot + '/ai/placement/modgen/prompt.php';

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                })
                .then(function(response) {
                    if (response.ok) {
                        window.location.reload();
                        return;
                    }
                    throw new Error('Form submission failed');
                })
                .catch(function(error) {
                    Notification.exception(error);
                    self.reactive.dispatch('closeModal');
                });
            });
        }

        /**
         * Open the modal.
         */
        open() {
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: open() called, dispatching openModal mutation');
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: Current state before dispatch:', this.reactive.state);
            this.reactive.dispatch('openModal');
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: openModal mutation dispatched');
        }
    };

    /**
     * Initialize the reactive modal generator.
     *
     * @param {number} courseid Course ID
     * @return {Promise} Promise resolving to component instance
     */
    var init = function(courseid) {
        // eslint-disable-next-line no-console
        console.log('Module Generator Reactive: Initializing with courseid', courseid);
        
        // Get reactive instance (creates it if needed, but doesn't set initial state yet)
        var reactive = getReactiveInstance();
        
        // Create component (this registers the watchers)
        // eslint-disable-next-line no-console
        console.log('Module Generator Reactive: Creating component');
        var component = new ModalGeneratorComponent({
            element: document.body,
            reactive: reactive,
            courseid: courseid,
        });

        // eslint-disable-next-line no-console
        console.log('Module Generator Reactive: Component created', component);
        
        // Now set the initial state if it hasn't been set yet
        // This will trigger stateReady() and activate the watchers
        if (!stateInitialized) {
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: Setting initial state NOW (after component creation)');
            reactive.setInitialState({
                modal: {
                    isOpen: false,
                    isLoading: false,
                    loadingMessage: '',
                },
                form: {
                    isValid: false,
                    isDirty: false,
                    isSubmitting: false,
                },
            });
            stateInitialized = true;
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: Initial state set');
            
            // Manually trigger stateReady on the component
            if (component.stateReady && typeof component.stateReady === 'function') {
                // eslint-disable-next-line no-console
                console.log('Module Generator Reactive: Manually calling component.stateReady()');
                component.stateReady();
            }
            
            // eslint-disable-next-line no-console
            console.log('Module Generator Reactive: Watchers should now be active');
        }
        
        return Promise.resolve(component);
    };

    return {
        init: init
    };
});
